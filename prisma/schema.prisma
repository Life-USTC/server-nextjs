generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

generator zod {
  provider = "prisma-zod-generator"
  output   = "../src/generated/zod"
}

datasource db {
  provider = "postgresql"
}

enum CommentVisibility {
  public
  logged_in_only
  anonymous
}

enum CommentStatus {
  active
  softbanned
  deleted
}

enum CommentReactionType {
  upvote
  downvote
  heart
  laugh
  hooray
  confused
  rocket
  eyes
}

enum HomeworkAuditAction {
  created
  deleted
}


model AdminClass {
  id   Int  @id @default(autoincrement())
  jwId Int? @unique

  code      String?
  grade     String?
  nameCn    String   @unique
  nameEn    String?
  stdCount  Int?
  planCount Int?
  enabled   Boolean?
  abbrZh    String?
  abbrEn    String?

  sections Section[] @relation("SectionAdminClasses")

  @@index([jwId])
  @@index([code])
  @@index([nameCn])
}

model Building {
  id   Int @id @default(autoincrement())
  jwId Int @unique

  nameCn String
  nameEn String?
  code   String

  campusId Int?

  campus Campus? @relation(fields: [campusId], references: [id])

  rooms Room[]

  @@index([jwId])
  @@index([nameCn])
  @@index([nameEn])
  @@index([campusId])
}

model Campus {
  id   Int  @id @default(autoincrement())
  jwId Int? @unique

  nameCn String  @unique
  nameEn String?
  code   String?

  buildings Building[]
  sections  Section[]

  @@index([jwId])
  @@index([code])
  @@index([nameCn])
  @@index([nameEn])
}

model ClassType {
  id Int @id @default(autoincrement())

  nameCn String  @unique
  nameEn String?

  courses Course[]

  @@index([nameCn])
  @@index([nameEn])
}

model Course {
  id   Int @id @default(autoincrement())
  jwId Int @unique

  code   String
  nameCn String
  nameEn String?

  categoryId       Int?
  classTypeId      Int?
  classifyId       Int?
  educationLevelId Int?
  gradationId      Int?
  typeId           Int?

  category       CourseCategory?  @relation(fields: [categoryId], references: [id])
  classType      ClassType?       @relation(fields: [classTypeId], references: [id])
  classify       CourseClassify?  @relation(fields: [classifyId], references: [id])
  educationLevel EducationLevel?  @relation(fields: [educationLevelId], references: [id])
  gradation      CourseGradation? @relation(fields: [gradationId], references: [id])
  type           CourseType?      @relation(fields: [typeId], references: [id])

  sections Section[]
  comments Comment[]
  description Description?

  @@index([jwId])
  @@index([code])
  @@index([nameCn])
  @@index([nameEn])
  @@index([categoryId])
  @@index([classTypeId])
  @@index([classifyId])
  @@index([educationLevelId])
  @@index([gradationId])
  @@index([typeId])
}

model CourseCategory {
  id Int @id @default(autoincrement())

  nameCn String  @unique
  nameEn String?

  courses Course[]

  @@index([nameCn])
  @@index([nameEn])
}

model CourseClassify {
  id Int @id @default(autoincrement())

  nameCn String  @unique
  nameEn String?

  courses Course[]

  @@index([nameCn])
  @@index([nameEn])
}

model CourseGradation {
  id Int @id @default(autoincrement())

  nameCn String  @unique
  nameEn String?

  courses Course[]

  @@index([nameCn])
  @@index([nameEn])
}

model CourseType {
  id Int @id @default(autoincrement())

  nameCn String  @unique
  nameEn String?

  courses Course[]

  @@index([nameCn])
  @@index([nameEn])
}

model Department {
  id Int @id @default(autoincrement())

  code      String   @unique
  nameCn    String
  nameEn    String?
  isCollege Boolean?

  sections Section[]
  teachers Teacher[]

  @@index([code])
  @@index([nameCn])
  @@index([nameEn])
}

model EducationLevel {
  id Int @id @default(autoincrement())

  nameCn String  @unique
  nameEn String?

  courses Course[]

  @@index([nameCn])
  @@index([nameEn])
}

model ExamMode {
  id Int @id @default(autoincrement())

  nameCn String  @unique
  nameEn String?

  sections Section[]

  @@index([nameCn])
  @@index([nameEn])
}

model Room {
  id   Int @id @default(autoincrement())
  jwId Int @unique

  nameCn          String
  nameEn          String?
  code            String
  floor           Int?
  virtual         Boolean
  seatsForSection Int
  remark          String?
  seats           Int

  buildingId Int?
  roomTypeId Int?

  building Building? @relation(fields: [buildingId], references: [id])
  roomType RoomType? @relation(fields: [roomTypeId], references: [id])

  schedules Schedule[]

  @@unique([buildingId, code])
  @@index([jwId])
  @@index([nameCn])
  @@index([nameEn])
}

model RoomType {
  id   Int @id @default(autoincrement())
  jwId Int @unique

  nameCn String
  nameEn String?
  code   String

  rooms    Room[]
  sections Section[]

  @@index([jwId])
  @@index([nameCn])
  @@index([nameEn])
}

model Schedule {
  id Int @id @default(autoincrement())

  periods       Int
  date          DateTime? @db.Date
  weekday       Int
  startTime     Int
  endTime       Int
  experiment    String?
  customPlace   String?
  lessonType    String?
  weekIndex     Int
  exerciseClass Boolean?
  startUnit     Int
  endUnit       Int

  roomId          Int?
  sectionId       Int
  scheduleGroupId Int

  room          Room?         @relation(fields: [roomId], references: [id])
  section       Section       @relation(fields: [sectionId], references: [id])
  scheduleGroup ScheduleGroup @relation(fields: [scheduleGroupId], references: [id])
  teachers      Teacher[]     @relation("ScheduleTeachers")

  @@index([date])
  @@index([roomId])
  @@index([sectionId])
  @@index([scheduleGroupId])
}

model ScheduleGroup {
  id   Int @id @default(autoincrement())
  jwId Int @unique

  no            Int
  limitCount    Int
  stdCount      Int
  actualPeriods Int
  isDefault     Boolean

  sectionId Int

  section Section @relation(fields: [sectionId], references: [id])

  schedules Schedule[]

  @@index([jwId])
  @@index([sectionId])
}

model Section {
  id   Int @id @default(autoincrement())
  jwId Int @unique

  code                    String
  bizTypeId               Int?
  credits                 Float?
  period                  Int?
  periodsPerWeek          Int?
  timesPerWeek            Int?
  stdCount                Int?
  limitCount              Int?
  graduateAndPostgraduate Boolean?
  dateTimePlaceText       String?
  dateTimePlacePersonText Json?

  actualPeriods     Int?
  theoryPeriods     Float?
  practicePeriods   Float?
  experimentPeriods Float?
  machinePeriods    Float?
  designPeriods     Float?
  testPeriods       Float?

  scheduleState           String?
  suggestScheduleWeeks    Json?
  suggestScheduleWeekInfo String?
  scheduleJsonParams      Json?
  selectedStdCount        Int?
  remark                  String?
  scheduleRemark          String?

  courseId         Int
  semesterId       Int?
  campusId         Int?
  examModeId       Int?
  openDepartmentId Int?
  teachLanguageId  Int?
  roomTypeId       Int?

  course         Course         @relation(fields: [courseId], references: [id])
  semester       Semester?      @relation(fields: [semesterId], references: [id])
  campus         Campus?        @relation(fields: [campusId], references: [id])
  examMode       ExamMode?      @relation(fields: [examModeId], references: [id])
  openDepartment Department?    @relation(fields: [openDepartmentId], references: [id])
  teachLanguage  TeachLanguage? @relation(fields: [teachLanguageId], references: [id])
  roomType       RoomType?      @relation(fields: [roomTypeId], references: [id])

  schedules             Schedule[]
  scheduleGroups        ScheduleGroup[]
  adminClasses          AdminClass[]           @relation("SectionAdminClasses")
  teachers              Teacher[]              @relation("SectionTeachers")
  sectionTeachers        SectionTeacher[]
  teacherAssignments    TeacherAssignment[]
  exams                 Exam[]
  subscribedUsers       User[]                @relation("UserCalendarSections")
  comments              Comment[]
  description           Description?
  homeworks             Homework[]
  homeworkAuditLogs     HomeworkAuditLog[]

  @@index([jwId])
  @@index([code])
  @@index([bizTypeId])
  @@index([period])
  @@index([graduateAndPostgraduate])
  @@index([courseId])
  @@index([semesterId])
  @@index([examModeId])
  @@index([campusId])
  @@index([openDepartmentId])
  @@index([roomTypeId])
  @@index([teachLanguageId])
}

model Exam {
  id   Int @id @default(autoincrement())
  jwId Int @unique

  examType      Int?
  startTime     Int?
  endTime       Int?
  examDate      DateTime? @db.Date
  examTakeCount Int?
  examMode      String?

  examBatchId Int?
  sectionId   Int
  examBatch   ExamBatch? @relation(fields: [examBatchId], references: [id], onDelete: Cascade)
  section     Section    @relation(fields: [sectionId], references: [id], onDelete: Cascade)

  examRooms ExamRoom[]

  @@index([jwId])
  @@index([examType])
  @@index([examDate])
  @@index([examBatchId])
  @@index([sectionId])
}

model ExamBatch {
  id Int @id @default(autoincrement())

  nameCn String  @unique
  nameEn String?

  exams Exam[]

  @@index([nameCn])
}

model ExamRoom {
  id Int @id @default(autoincrement())

  room  String
  count Int

  examId Int
  exam   Exam @relation(fields: [examId], references: [id], onDelete: Cascade)

  @@index([examId])
  @@index([room])
}

model Semester {
  id   Int @id @default(autoincrement())
  jwId Int @unique

  nameCn    String
  code      String
  startDate DateTime? @db.Date
  endDate   DateTime? @db.Date

  sections Section[]

  @@index([jwId])
}

model Teacher {
  id Int @id @default(autoincrement())

  personId  Int?    @unique
  teacherId Int?    @unique
  code      String? @unique
  nameCn    String
  nameEn    String?
  age       Int?

  email     String?
  telephone String?
  mobile    String?
  address   String?
  postcode  String?
  qq        String?
  wechat    String?

  departmentId   Int?
  teacherTitleId Int?

  department   Department?   @relation(fields: [departmentId], references: [id])
  teacherTitle TeacherTitle? @relation(fields: [teacherTitleId], references: [id])

  sections           Section[]           @relation("SectionTeachers")
  sectionTeachers    SectionTeacher[]
  teacherAssignments TeacherAssignment[]
  schedules          Schedule[]          @relation("ScheduleTeachers")
  comments           Comment[]
  description        Description?

  @@unique([nameCn, departmentId])
  @@index([code])
  @@index([nameCn])
  @@index([nameEn])
  @@index([teacherTitleId])
  @@index([departmentId])
}

model Description {
  id String @id @default(cuid())

  content String @default("")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  lastEditedAt DateTime?

  lastEditedById String?
  lastEditedBy   User?   @relation("DescriptionLastEditor", fields: [lastEditedById], references: [id], onDelete: SetNull)

  sectionId Int? @unique
  courseId  Int? @unique
  teacherId Int? @unique
  homeworkId String? @unique

  section Section? @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  course  Course?  @relation(fields: [courseId], references: [id], onDelete: Cascade)
  teacher Teacher? @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  homework Homework? @relation(fields: [homeworkId], references: [id], onDelete: Cascade)

  edits DescriptionEdit[]

  @@index([lastEditedById])
  @@index([homeworkId])
}

model Homework {
  id String @id @default(cuid())

  title String
  isMajor      Boolean @default(false)
  requiresTeam Boolean @default(false)

  publishedAt       DateTime?
  submissionStartAt DateTime?
  submissionDueAt   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?

  sectionId Int
  section   Section @relation(fields: [sectionId], references: [id], onDelete: Cascade)

  createdById String?
  createdBy   User?   @relation("HomeworkCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)

  updatedById String?
  updatedBy   User?   @relation("HomeworkUpdatedBy", fields: [updatedById], references: [id], onDelete: SetNull)

  deletedById String?
  deletedBy   User?   @relation("HomeworkDeletedBy", fields: [deletedById], references: [id], onDelete: SetNull)

  description Description?
  comments    Comment[]
  auditLogs   HomeworkAuditLog[]
  homeworkCompletions HomeworkCompletion[]

  @@index([sectionId])
  @@index([publishedAt])
  @@index([submissionDueAt])
  @@index([deletedAt])
  @@index([createdById])
  @@index([sectionId, deletedAt])
}

model HomeworkCompletion {
  userId     String
  homeworkId String
  completedAt DateTime @default(now())

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  homework Homework @relation(fields: [homeworkId], references: [id], onDelete: Cascade)

  @@id([userId, homeworkId])
  @@index([homeworkId])
  @@index([userId])
}

model HomeworkAuditLog {
  id String @id @default(cuid())

  action HomeworkAuditAction
  titleSnapshot String

  createdAt DateTime @default(now())

  sectionId Int
  section   Section @relation(fields: [sectionId], references: [id], onDelete: Cascade)

  homeworkId String?
  homework   Homework? @relation(fields: [homeworkId], references: [id], onDelete: SetNull)

  actorId String?
  actor   User?   @relation("HomeworkAuditActor", fields: [actorId], references: [id], onDelete: SetNull)

  @@index([sectionId])
  @@index([homeworkId])
  @@index([actorId])
  @@index([createdAt])
}

model DescriptionEdit {
  id String @id @default(cuid())

  descriptionId String
  description   Description @relation(fields: [descriptionId], references: [id], onDelete: Cascade)

  editorId String?
  editor   User?   @relation("DescriptionEdits", fields: [editorId], references: [id], onDelete: SetNull)

  previousContent String?
  nextContent     String

  createdAt DateTime @default(now())

  @@index([descriptionId])
  @@index([editorId])
  @@index([createdAt])
}

model SectionTeacher {
  id Int @id @default(autoincrement())

  sectionId Int
  teacherId Int

  section Section @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  teacher Teacher @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  comments Comment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([sectionId, teacherId])
  @@index([sectionId])
  @@index([teacherId])
}

model TeachLanguage {
  id Int @id @default(autoincrement())

  nameCn String  @unique
  nameEn String?

  sections Section[]

  @@index([nameCn])
  @@index([nameEn])
}

model TeacherTitle {
  id   Int @id @default(autoincrement())
  jwId Int @unique

  nameCn  String   @unique
  nameEn  String?
  code    String
  enabled Boolean?

  teachers Teacher[]

  @@index([jwId])
  @@index([nameCn])
}

model TeacherLessonType {
  id   Int @id @default(autoincrement())
  jwId Int @unique

  nameCn  String
  nameEn  String?
  code    String
  role    String?
  enabled Boolean?

  teacherAssignments TeacherAssignment[]

  @@index([jwId])
  @@index([nameCn])
}

model TeacherAssignment {
  id Int @id @default(autoincrement())

  teacherId Int
  sectionId Int

  role           String?
  period         Int?
  weekIndices    Json?
  weekIndicesMsg String?

  teacherLessonTypeId Int?

  teacher           Teacher            @relation(fields: [teacherId], references: [id])
  section           Section            @relation(fields: [sectionId], references: [id])
  teacherLessonType TeacherLessonType? @relation(fields: [teacherLessonTypeId], references: [id])

  @@unique([teacherId, sectionId])
  @@index([teacherId])
  @@index([sectionId])
  @@index([teacherLessonTypeId])
}

model User {
  id              String   @id @default(cuid())
  name            String?
  username        String?  @unique
  image           String?
  profilePictures String[] @default([])
  isAdmin         Boolean  @default(false)
  calendarFeedToken String? @unique

  accounts      Account[]
  sessions      Session[]
  // Optional for WebAuthn support
  Authenticator Authenticator[]

  verifiedEmails VerifiedEmail[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  subscribedSections   Section[]           @relation("UserCalendarSections")
  uploads              Upload[]
  uploadPendings       UploadPending[]
  comments             Comment[]
  moderatedComments    Comment[]           @relation("ModeratedComments")
  commentReactions     CommentReaction[]
  suspensions          UserSuspension[]    @relation("SuspendedUser")
  suspensionsIssued    UserSuspension[]    @relation("SuspensionCreatedBy")
  suspensionsLifted    UserSuspension[]    @relation("SuspensionLiftedBy")
  descriptionEdits     DescriptionEdit[]   @relation("DescriptionEdits")
  descriptionLastEdits Description[]       @relation("DescriptionLastEditor")
  homeworksCreated     Homework[]          @relation("HomeworkCreatedBy")
  homeworksUpdated     Homework[]          @relation("HomeworkUpdatedBy")
  homeworksDeleted     Homework[]          @relation("HomeworkDeletedBy")
  homeworkAuditLogs    HomeworkAuditLog[]  @relation("HomeworkAuditActor")
  homeworkCompletions  HomeworkCompletion[]
}

model Upload {
  id          String   @id @default(cuid())
  key         String   @unique
  filename    String
  contentType String?
  size        Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  commentAttachments CommentAttachment[]

  @@index([userId])
}

model Comment {
  id String @id @default(cuid())

  body       String
  visibility CommentVisibility @default(public)
  status     CommentStatus     @default(active)
  isAnonymous Boolean          @default(false)
  authorName String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?
  moderatedAt DateTime?
  moderationNote String?

  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  moderatedById String?
  moderatedBy   User? @relation("ModeratedComments", fields: [moderatedById], references: [id], onDelete: SetNull)

  parentId String?
  parent   Comment? @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies  Comment[] @relation("CommentReplies")

  rootId String?
  root   Comment?  @relation("CommentRoot", fields: [rootId], references: [id], onDelete: Cascade)
  thread Comment[] @relation("CommentRoot")

  sectionId        Int?
  courseId         Int?
  teacherId        Int?
  sectionTeacherId Int?
  homeworkId       String?

  section        Section?       @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  course         Course?        @relation(fields: [courseId], references: [id], onDelete: Cascade)
  teacher        Teacher?       @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  sectionTeacher SectionTeacher? @relation(fields: [sectionTeacherId], references: [id], onDelete: Cascade)
  homework       Homework?      @relation(fields: [homeworkId], references: [id], onDelete: Cascade)

  attachments CommentAttachment[]
  reactions   CommentReaction[]

  @@index([userId])
  @@index([parentId])
  @@index([rootId])
  @@index([sectionId])
  @@index([courseId])
  @@index([teacherId])
  @@index([sectionTeacherId])
  @@index([homeworkId])
  @@index([status])
  @@index([visibility])
  @@index([userId, status])
  @@index([sectionId, status])
  @@index([courseId, status])
  @@index([teacherId, status])
}

model CommentAttachment {
  id String @id @default(cuid())

  commentId String
  uploadId  String
  createdAt DateTime @default(now())

  comment Comment @relation(fields: [commentId], references: [id], onDelete: Cascade)
  upload  Upload  @relation(fields: [uploadId], references: [id], onDelete: Cascade)

  @@unique([commentId, uploadId])
  @@index([uploadId])
}

model CommentReaction {
  id String @id @default(cuid())

  type      CommentReactionType
  createdAt DateTime @default(now())

  commentId String
  userId    String

  comment Comment @relation(fields: [commentId], references: [id], onDelete: Cascade)
  user    User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([commentId, userId, type])
  @@index([userId])
  @@index([commentId])
}

model UserSuspension {
  id String @id @default(cuid())

  userId      String
  createdById String
  createdAt   DateTime @default(now())
  reason      String?
  note        String?
  expiresAt   DateTime?

  liftedAt   DateTime?
  liftedById String?

  user      User  @relation("SuspendedUser", fields: [userId], references: [id], onDelete: Cascade)
  createdBy User  @relation("SuspensionCreatedBy", fields: [createdById], references: [id], onDelete: Cascade)
  liftedBy  User? @relation("SuspensionLiftedBy", fields: [liftedById], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([createdById])
  @@index([liftedAt])
  @@index([expiresAt])
  @@index([userId, liftedAt])
}

model UploadPending {
  id          String   @id @default(cuid())
  key         String   @unique
  filename    String
  contentType String?
  size        Int
  expiresAt   DateTime
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@index([userId, expiresAt])
}

model VerifiedEmail {
  id        Int      @id @default(autoincrement())
  email     String
  provider  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, email])
  @@index([userId])
}

model Account {
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([provider, providerAccountId])
  @@index([userId])
}

model Session {
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String
  expires    DateTime

  @@id([identifier, token])
}

// Optional for WebAuthn support
model Authenticator {
  credentialID         String  @unique
  userId               String
  providerAccountId    String
  credentialPublicKey  String
  counter              Int
  credentialDeviceType String
  credentialBackedUp   Boolean
  transports           String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, credentialID])
}
